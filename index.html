<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <title>ИмбаБанк | Кликер с друзьями</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Сброс и базовые стили */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-font-smoothing: antialiased;
        }

        :root {
            --primary: #6B46C1;
            --primary-dark: #553C9A;
            --secondary: #805AD5;
            --accent: #9F7AEA;
            --dark: #121212;
            --darker: #0A0A0A;
            --light: #FFFFFF;
            --gray: #E2E8F0;
            --gray-dark: #4A5568;
            --success: #38A169;
            --error: #E53E3E;
            --warning: #D69E2E;
            --card-bg: #1E1E1E;
            --border: #333333;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: var(--dark);
            color: var(--light);
            min-height: 100vh;
            line-height: 1.4;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            overflow-x: hidden;
        }

        /* Контейнер приложения */
        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 0;
        }

        /* Шапка с аватаркой Telegram */
        .header {
            background: var(--darker);
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid var(--accent);
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-placeholder {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1.2rem;
        }

        .user-details {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 2px;
        }

        .user-id {
            font-size: 0.8rem;
            color: var(--gray);
        }

        .balance-display {
            font-size: 1.1rem;
            font-weight: 600;
            background: var(--primary);
            padding: 6px 12px;
            border-radius: 20px;
            color: white;
            white-space: nowrap;
        }

        /* Основной контент */
        .main-content {
            flex: 1;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        /* Карточка баланса */
        .balance-card {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            color: white;
            margin-bottom: 8px;
        }

        .balance-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .balance-amount {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .balance-subtext {
            font-size: 0.85rem;
            opacity: 0.8;
        }

        /* Кликер */
        .clicker-container {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .clicker-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--light);
        }

        .clicker-button {
            width: 140px;
            height: 140px;
            margin: 0 auto 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), #FF6B8B);
            border: none;
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            transition: transform 0.1s, box-shadow 0.1s;
            touch-action: manipulation;
        }

        .clicker-button:active {
            transform: scale(0.95);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .clicker-button i {
            font-size: 2.5rem;
        }

        .clicker-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 16px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 12px;
        }

        .stat-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--warning);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        /* Лидерборд */
        .leaderboard-container {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border);
        }

        .leaderboard-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .leaderboard-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .leaderboard-tab {
            flex: 1;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--gray);
            font-size: 0.9rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .leaderboard-tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .leaderboard-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid transparent;
            transition: all 0.2s;
        }

        .leaderboard-item.me {
            background: rgba(159, 122, 234, 0.1);
            border-color: var(--accent);
        }

        .rank {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .rank-1 { background: #FFD700; color: #000; }
        .rank-2 { background: #C0C0C0; color: #000; }
        .rank-3 { background: #CD7F32; color: #000; }
        .rank-other { background: var(--gray-dark); color: white; }

        .leaderboard-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            flex-shrink: 0;
        }

        .leaderboard-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .leaderboard-info {
            flex: 1;
            min-width: 0;
        }

        .leaderboard-name {
            font-weight: 600;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .leaderboard-level {
            font-size: 0.8rem;
            color: var(--gray);
        }

        .leaderboard-score {
            font-weight: 700;
            color: var(--warning);
            font-size: 1.1rem;
            flex-shrink: 0;
        }

        /* Список друзей */
        .friends-container {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border);
        }

        .friends-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .friends-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--light);
        }

        .friends-search {
            background: var(--dark);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 8px 16px;
            color: var(--light);
            font-size: 0.9rem;
            width: 100%;
            margin-bottom: 16px;
        }

        .friends-search:focus {
            outline: none;
            border-color: var(--accent);
        }

        .friends-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .friend-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .friend-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            overflow: hidden;
            flex-shrink: 0;
        }

        .friend-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .friend-info {
            flex: 1;
            min-width: 0;
        }

        .friend-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .friend-balance {
            font-size: 0.9rem;
            color: var(--gray);
        }

        .friend-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .friend-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            touch-action: manipulation;
        }

        .friend-btn:active {
            transform: scale(0.9);
        }

        .friend-btn.send {
            background: var(--success);
            color: white;
        }

        .friend-btn.request {
            background: var(--warning);
            color: var(--dark);
        }

        /* Карты */
        .cards-container {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border);
        }

        .cards-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--light);
        }

        .cards-grid {
            display: grid;
            gap: 12px;
        }

        .card-item {
            background: linear-gradient(135deg, #2D3748, #4A5568);
            border-radius: 12px;
            padding: 16px;
            position: relative;
            overflow: hidden;
        }

        .card-item::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(159,122,234,0.1) 0%, transparent 70%);
        }

        .card-number {
            font-family: monospace;
            font-size: 1rem;
            letter-spacing: 1px;
            margin-bottom: 8px;
            color: white;
        }

        .card-balance {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--success);
            margin-bottom: 4px;
        }

        .card-name {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
        }

        /* Кнопки действий */
        .actions-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 8px;
        }

        .action-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            touch-action: manipulation;
        }

        .action-btn:active {
            transform: scale(0.96);
            background: var(--primary-dark);
        }

        .action-btn.wide {
            grid-column: 1 / -1;
        }

        /* Модальные окна */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 16px;
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            width: 100%;
            max-width: 400px;
            border: 1px solid var(--border);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--light);
        }

        .close-btn {
            background: transparent;
            border: none;
            color: var(--gray);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 4px;
            line-height: 1;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: var(--gray);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            background: var(--dark);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--light);
            font-size: 1rem;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* Запросы в долг */
        .requests-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .request-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
        }

        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .request-user {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .request-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            overflow: hidden;
        }

        .request-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .request-name {
            font-weight: 600;
        }

        .request-amount {
            font-weight: 700;
            color: var(--warning);
            font-size: 1.1rem;
        }

        .request-message {
            color: var(--gray);
            font-size: 0.9rem;
            margin-bottom: 12px;
        }

        .request-actions {
            display: flex;
            gap: 8px;
        }

        .request-btn {
            flex: 1;
            padding: 10px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .request-btn.accept {
            background: var(--success);
            color: white;
        }

        .request-btn.reject {
            background: var(--error);
            color: white;
        }

        /* Боттом-бар навигации */
        .bottom-nav {
            background: var(--darker);
            border-top: 1px solid var(--border);
            padding: 12px 16px;
            position: sticky;
            bottom: 0;
            z-index: 100;
        }

        .nav-tabs {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }

        .nav-tab {
            background: transparent;
            border: none;
            color: var(--gray);
            padding: 12px 8px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
            touch-action: manipulation;
        }

        .nav-tab:active {
            background: rgba(255, 255, 255, 0.05);
            transform: scale(0.95);
        }

        .nav-tab.active {
            color: var(--accent);
            background: rgba(159, 122, 234, 0.1);
        }

        .nav-tab i {
            font-size: 1.2rem;
        }

        .tab-badge {
            position: absolute;
            top: 4px;
            right: 4px;
            background: var(--error);
            color: white;
            font-size: 0.7rem;
            min-width: 18px;
            height: 18px;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
        }

        /* Страницы */
        .page {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Улучшения */
        .upgrades-container {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border);
        }

        .upgrades-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--light);
        }

        .upgrades-grid {
            display: grid;
            gap: 12px;
        }

        .upgrade-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
            touch-action: manipulation;
        }

        .upgrade-card:active {
            background: rgba(159, 122, 234, 0.1);
            transform: scale(0.98);
        }

        .upgrade-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .upgrade-card.disabled:active {
            transform: none;
            background: rgba(255, 255, 255, 0.03);
        }

        .upgrade-info {
            flex: 1;
        }

        .upgrade-name {
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--light);
        }

        .upgrade-desc {
            font-size: 0.85rem;
            color: var(--gray);
            margin-bottom: 6px;
        }

        .upgrade-price {
            font-size: 0.9rem;
            color: var(--warning);
            font-weight: 600;
        }

        .upgrade-owned {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--success);
            font-size: 0.85rem;
        }

        /* Адаптивность */
        @media (min-width: 768px) {
            .main-content {
                max-width: 480px;
                margin: 0 auto;
                width: 100%;
            }
            
            .clicker-button {
                width: 160px;
                height: 160px;
            }
        }

        /* Для очень маленьких экранов */
        @media (max-height: 600px) {
            .clicker-button {
                width: 120px;
                height: 120px;
            }
            
            .clicker-button i {
                font-size: 2rem;
            }
        }

        /* Утилиты */
        .text-center { text-align: center; }
        .text-success { color: var(--success); }
        .text-error { color: var(--error); }
        .text-warning { color: var(--warning); }
        .text-muted { color: var(--gray-dark); }
        .mb-2 { margin-bottom: 8px; }
        .mb-3 { margin-bottom: 16px; }
        .mt-2 { margin-top: 8px; }
        .mt-3 { margin-top: 16px; }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Шапка с Telegram данными -->
        <header class="header">
            <div class="header-content">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">
                        <div class="avatar-placeholder" id="avatarPlaceholder">ТГ</div>
                    </div>
                    <div class="user-details">
                        <div class="user-name" id="userName">Пользователь</div>
                        <div class="user-id" id="userId">ID: 0</div>
                    </div>
                </div>
                <div class="balance-display" id="userBalance">0 ИК</div>
            </div>
        </header>

        <!-- Основной контент -->
        <main class="main-content">
            <!-- Главная страница (кликер) -->
            <div id="clickerPage" class="page active">
                <div class="balance-card">
                    <div class="balance-label">Ваш баланс</div>
                    <div class="balance-amount" id="totalBalance">0</div>
                    <div class="balance-subtext">Имбакоинов</div>
                </div>

                <div class="clicker-container">
                    <h2 class="clicker-title">Зарабатывай кликами!</h2>
                    <button class="clicker-button" id="clickerBtn">
                        <i class="fas fa-hand-pointer"></i>
                        <span>Клик!</span>
                    </button>
                    
                    <div class="clicker-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="perClick">10</div>
                            <div class="stat-label">За клик</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="multiplier">x1.0</div>
                            <div class="stat-label">Множитель</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="clicksCount">0</div>
                            <div class="stat-label">Кликов</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="totalEarned">0</div>
                            <div class="stat-label">Заработано</div>
                        </div>
                    </div>
                </div>

                <div class="upgrades-container">
                    <h2 class="upgrades-title">Улучшения</h2>
                    <div class="upgrades-grid" id="upgradesList">
                        <!-- Улучшения загружаются динамически -->
                    </div>
                </div>
            </div>

            <!-- Лидерборд -->
            <div id="leaderboardPage" class="page">
                <div class="leaderboard-container">
                    <div class="leaderboard-title">
                        <span>Топ игроков</span>
                        <span class="text-warning" id="playerRank">#0</span>
                    </div>
                    
                    <div class="leaderboard-tabs">
                        <button class="leaderboard-tab active" data-tab="balance">По балансу</button>
                        <button class="leaderboard-tab" data-tab="clicks">По кликам</button>
                        <button class="leaderboard-tab" data-tab="friends">По друзьям</button>
                    </div>
                    
                    <div class="leaderboard-list" id="leaderboardList">
                        <!-- Лидерборд загружается динамически -->
                    </div>
                </div>
            </div>

            <!-- Друзья -->
            <div id="friendsPage" class="page">
                <div class="friends-container">
                    <div class="friends-header">
                        <div class="friends-title">Друзья</div>
                        <button class="action-btn" onclick="app.openAddFriendModal()">
                            <i class="fas fa-user-plus"></i>
                            <span>Добавить</span>
                        </button>
                    </div>
                    
                    <input type="text" class="friends-search" placeholder="Поиск друзей..." id="friendsSearch">
                    
                    <div class="friends-list" id="friendsList">
                        <!-- Друзья загружаются динамически -->
                    </div>
                </div>
                
                <div class="requests-container">
                    <div class="friends-title mb-2">Запросы в долг</div>
                    <div class="requests-list" id="requestsList">
                        <!-- Запросы загружаются динамически -->
                    </div>
                </div>
            </div>

            <!-- Карты -->
            <div id="cardsPage" class="page">
                <div class="cards-container">
                    <h2 class="cards-title">Виртуальные карты</h2>
                    <div class="cards-grid" id="cardsList">
                        <!-- Карты загружаются динамически -->
                    </div>
                    
                    <div class="actions-container mt-3">
                        <button class="action-btn" onclick="app.createCard()">
                            <i class="fas fa-plus"></i>
                            <span>Новая карта</span>
                        </button>
                        <button class="action-btn" onclick="app.openTransferModal()">
                            <i class="fas fa-exchange-alt"></i>
                            <span>Перевести</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Профиль -->
            <div id="profilePage" class="page">
                <div class="cards-container">
                    <h2 class="cards-title">Профиль</h2>
                    
                    <div class="balance-card mb-3">
                        <div class="balance-label">Общая статистика</div>
                        <div class="balance-amount" id="profileBalance">0</div>
                    </div>
                    
                    <div class="clicker-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="profileClicks">0</div>
                            <div class="stat-label">Всего кликов</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="profileEarned">0</div>
                            <div class="stat-label">Заработано</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="profileCards">0</div>
                            <div class="stat-label">Карт</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="profileFriends">0</div>
                            <div class="stat-label">Друзей</div>
                        </div>
                    </div>
                    
                    <div class="actions-container mt-3">
                        <button class="action-btn" onclick="app.resetProgress()">
                            <i class="fas fa-redo"></i>
                            <span>Сбросить</span>
                        </button>
                        <button class="action-btn wide" onclick="app.shareProfile()">
                            <i class="fas fa-share-alt"></i>
                            <span>Поделиться профилем</span>
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Модальные окна -->
        <div id="addFriendModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Добавить друга</h2>
                    <button class="close-btn" onclick="app.closeModal('addFriendModal')">&times;</button>
                </div>
                <div class="form-group">
                    <label class="form-label">ID пользователя</label>
                    <input type="number" class="form-input" id="friendIdInput" placeholder="Введите ID пользователя">
                </div>
                <button class="action-btn wide" onclick="app.addFriend()">Добавить друга</button>
                <div class="mt-3 text-center text-muted">
                    <small>ID можно узнать в профиле пользователя</small>
                </div>
            </div>
        </div>

        <div id="transferModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Перевод другу</h2>
                    <button class="close-btn" onclick="app.closeModal('transferModal')">&times;</button>
                </div>
                <div class="form-group">
                    <label class="form-label">Выберите друга</label>
                    <select class="form-input" id="transferFriendSelect">
                        <!-- Друзья загружаются динамически -->
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Сумма перевода</label>
                    <input type="number" class="form-input" id="transferAmount" placeholder="Введите сумму">
                </div>
                <div class="form-group">
                    <label class="form-label">Сообщение (необязательно)</label>
                    <input type="text" class="form-input" id="transferMessage" placeholder="На подарок">
                </div>
                <button class="action-btn wide" onclick="app.sendTransfer()">Отправить перевод</button>
            </div>
        </div>

        <div id="loanRequestModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Запрос в долг</h2>
                    <button class="close-btn" onclick="app.closeModal('loanRequestModal')">&times;</button>
                </div>
                <div class="form-group">
                    <label class="form-label">Выберите друга</label>
                    <select class="form-input" id="loanFriendSelect">
                        <!-- Друзья загружаются динамически -->
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Сумма займа</label>
                    <input type="number" class="form-input" id="loanAmount" placeholder="Введите сумму">
                </div>
                <div class="form-group">
                    <label class="form-label">Сообщение для друга</label>
                    <input type="text" class="form-input" id="loanMessage" placeholder="Объясните, зачем вам нужны деньги">
                </div>
                <button class="action-btn wide" onclick="app.sendLoanRequest()">Отправить запрос</button>
            </div>
        </div>

        <div id="friendDetailsModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title" id="friendDetailsName">Друг</h2>
                    <button class="close-btn" onclick="app.closeModal('friendDetailsModal')">&times;</button>
                </div>
                <div class="text-center mb-3">
                    <div class="leaderboard-avatar" id="friendDetailsAvatar">
                        <div class="avatar-placeholder">Д</div>
                    </div>
                    <div class="mt-2">
                        <div class="text-muted">Баланс:</div>
                        <div class="balance-amount" id="friendDetailsBalance">0</div>
                    </div>
                </div>
                <div class="actions-container">
                    <button class="action-btn" onclick="app.sendMoneyToSelectedFriend()">
                        <i class="fas fa-paper-plane"></i>
                        <span>Перевести</span>
                    </button>
                    <button class="action-btn" onclick="app.requestLoanFromSelectedFriend()">
                        <i class="fas fa-hand-holding-usd"></i>
                        <span>Попросить в долг</span>
                    </button>
                </div>
                <button class="action-btn wide mt-3" onclick="app.removeSelectedFriend()">
                    <i class="fas fa-user-times"></i>
                    <span>Удалить из друзей</span>
                </button>
            </div>
        </div>

        <!-- Навигация -->
        <nav class="bottom-nav">
            <div class="nav-tabs">
                <button class="nav-tab active" data-page="clicker">
                    <i class="fas fa-coins"></i>
                    <span>Кликер</span>
                </button>
                <button class="nav-tab" data-page="leaderboard">
                    <i class="fas fa-trophy"></i>
                    <span>Топ</span>
                </button>
                <button class="nav-tab" data-page="friends">
                    <i class="fas fa-users"></i>
                    <span>Друзья</span>
                    <span class="tab-badge" id="requestsBadge" style="display: none;">0</span>
                </button>
                <button class="nav-tab" data-page="cards">
                    <i class="fas fa-credit-card"></i>
                    <span>Карты</span>
                </button>
                <button class="nav-tab" data-page="profile">
                    <i class="fas fa-user"></i>
                    <span>Профиль</span>
                </button>
            </div>
        </nav>
    </div>

    <script>
        // Telegram WebApp API
        const TelegramWebApp = window.Telegram?.WebApp || {
            ready: () => console.log('Telegram WebApp not available'),
            expand: () => {},
            sendData: (data) => console.log('Send to Telegram:', data),
            onEvent: (event, handler) => console.log('Event:', event),
            offEvent: (event, handler) => console.log('Off event:', event),
            initData: '',
            initDataUnsafe: {
                user: {
                    id: Math.floor(Math.random() * 1000000),
                    first_name: 'Тестовый',
                    last_name: 'Пользователь',
                    username: 'test_user',
                    photo_url: null
                }
            },
            showAlert: (msg) => alert(msg),
            showConfirm: (msg, callback) => {
                const result = confirm(msg);
                if (callback) callback(result);
            }
        };

        // Инициализация Telegram WebApp
        TelegramWebApp.ready();
        TelegramWebApp.expand();

        // Модель данных пользователя
        class UserData {
            constructor() {
                this.data = this.loadData();
                this.initTelegramData();
            }

            initTelegramData() {
                const tgUser = TelegramWebApp.initDataUnsafe.user;
                if (tgUser && !this.data.telegramData) {
                    this.data.telegramData = {
                        id: tgUser.id,
                        firstName: tgUser.first_name || '',
                        lastName: tgUser.last_name || '',
                        username: tgUser.username || '',
                        photoUrl: tgUser.photo_url || null,
                        languageCode: tgUser.language_code || 'ru'
                    };
                    this.save();
                }
            }

            loadData() {
                const saved = localStorage.getItem('imbabank_data');
                if (saved) {
                    return JSON.parse(saved);
                }

                // Начальные данные
                return {
                    balance: 1000,
                    clicks: 0,
                    earned: 0,
                    friends: [],
                    outgoingRequests: [],
                    incomingRequests: [],
                    cards: [
                        {
                            id: 1,
                            number: '0228 4455 6677 8899',
                            balance: 1000,
                            name: 'Основная карта',
                            created: new Date().toISOString()
                        }
                    ],
                    upgrades: [],
                    transactions: [
                        {
                            id: 1,
                            type: 'income',
                            amount: 1000,
                            description: 'Начальный бонус',
                            date: new Date().toISOString(),
                            time: Date.now()
                        }
                    ],
                    telegramData: null
                };
            }

            save() {
                localStorage.setItem('imbabank_data', JSON.stringify(this.data));
                this.updateTelegram();
            }

            updateTelegram() {
                // Отправляем данные в Telegram
                TelegramWebApp.sendData(JSON.stringify({
                    action: 'update',
                    balance: this.data.balance,
                    clicks: this.data.clicks,
                    earned: this.data.earned,
                    friends: this.data.friends.length
                }));
            }

            // Геттеры
            get balance() { return this.data.balance; }
            get clicks() { return this.data.clicks; }
            get earned() { return this.data.earned; }
            get friends() { return this.data.friends; }
            get outgoingRequests() { return this.data.outgoingRequests; }
            get incomingRequests() { return this.data.incomingRequests; }
            get cards() { return this.data.cards; }
            get upgrades() { return this.data.upgrades; }
            get transactions() { return this.data.transactions; }
            get telegramData() { return this.data.telegramData; }

            // Методы для работы с данными
            addBalance(amount) {
                this.data.balance += amount;
                this.data.earned += amount;
                this.save();
                return this.data.balance;
            }

            addClick() {
                this.data.clicks++;
                this.save();
                return this.data.clicks;
            }

            spendBalance(amount) {
                if (this.data.balance >= amount) {
                    this.data.balance -= amount;
                    this.save();
                    return true;
                }
                return false;
            }

            addCard(card) {
                this.data.cards.push(card);
                this.save();
                return card;
            }

            addTransaction(transaction) {
                this.data.transactions.unshift(transaction);
                if (this.data.transactions.length > 50) {
                    this.data.transactions.pop();
                }
                this.save();
            }

            addUpgrade(upgradeId) {
                if (!this.data.upgrades.includes(upgradeId)) {
                    this.data.upgrades.push(upgradeId);
                    this.save();
                }
            }

            // Методы для друзей
            addFriend(friendData) {
                if (!this.data.friends.some(f => f.id === friendData.id)) {
                    this.data.friends.push(friendData);
                    this.save();
                    return true;
                }
                return false;
            }

            removeFriend(friendId) {
                const index = this.data.friends.findIndex(f => f.id === friendId);
                if (index !== -1) {
                    this.data.friends.splice(index, 1);
                    this.save();
                    return true;
                }
                return false;
            }

            sendLoanRequest(friendId, amount, message) {
                const request = {
                    id: Date.now(),
                    fromUserId: this.telegramData?.id || 0,
                    toUserId: friendId,
                    amount: amount,
                    message: message,
                    status: 'pending',
                    date: new Date().toISOString()
                };
                this.data.outgoingRequests.push(request);
                this.save();
                return request;
            }

            receiveLoanRequest(request) {
                this.data.incomingRequests.push(request);
                this.save();
            }

            respondToLoanRequest(requestId, accepted) {
                const index = this.data.incomingRequests.findIndex(r => r.id === requestId);
                if (index !== -1) {
                    const request = this.data.incomingRequests[index];
                    request.status = accepted ? 'accepted' : 'rejected';
                    request.respondedAt = new Date().toISOString();
                    this.save();
                    return request;
                }
                return null;
            }

            reset() {
                localStorage.removeItem('imbabank_data');
                this.data = this.loadData();
                this.save();
                return this.data;
            }
        }

        // Менеджер улучшений
        class UpgradeManager {
            constructor() {
                this.upgrades = [
                    {
                        id: 'clickPower1',
                        name: 'Усиленный клик I',
                        description: '+10 за клик',
                        price: 1000,
                        effect: { perClick: 10 },
                        icon: 'fa-bolt'
                    },
                    {
                        id: 'clickPower2',
                        name: 'Усиленный клик II',
                        description: '+25 за клик',
                        price: 5000,
                        effect: { perClick: 25 },
                        icon: 'fa-bolt',
                        requires: 'clickPower1'
                    },
                    {
                        id: 'multiplier1',
                        name: 'Множитель x1.5',
                        description: 'Увеличивает доход',
                        price: 3000,
                        effect: { multiplier: 1.5 },
                        icon: 'fa-times-circle'
                    },
                    {
                        id: 'multiplier2',
                        name: 'Множитель x2.0',
                        description: 'Ещё больше доход',
                        price: 10000,
                        effect: { multiplier: 2.0 },
                        icon: 'fa-times-circle',
                        requires: 'multiplier1'
                    },
                    {
                        id: 'autoClicker',
                        name: 'Автокликер',
                        description: '5 ИК в секунду',
                        price: 15000,
                        effect: { autoClicker: true },
                        icon: 'fa-robot'
                    },
                    {
                        id: 'friendBonus',
                        name: 'Бонус за друзей',
                        description: '+1% за каждого друга',
                        price: 20000,
                        effect: { friendMultiplier: 0.01 },
                        icon: 'fa-users'
                    }
                ];
            }

            getAvailableUpgrades(userData) {
                return this.upgrades.filter(upgrade => {
                    // Проверяем требования
                    if (upgrade.requires && !userData.upgrades.includes(upgrade.requires)) {
                        return false;
                    }
                    // Проверяем, куплено ли уже
                    return !userData.upgrades.includes(upgrade.id);
                });
            }
        }

        // Глобальная система пользователей (симуляция сервера)
        class GlobalUsers {
            static users = new Map();
            
            static init() {
                // Загружаем из localStorage или создаем тестовых пользователей
                const saved = localStorage.getItem('imbabank_global_users');
                if (saved) {
                    const users = JSON.parse(saved);
                    users.forEach(user => this.users.set(user.id, user));
                } else {
                    // Создаем тестовых пользователей
                    const testUsers = [
                        {
                            id: 111111,
                            firstName: 'Алексей',
                            lastName: 'Иванов',
                            username: 'alexey_ivanov',
                            balance: 15000,
                            clicks: 5000,
                            earned: 20000,
                            friends: [],
                            photoUrl: null
                        },
                        {
                            id: 222222,
                            firstName: 'Мария',
                            lastName: 'Петрова',
                            username: 'maria_petrova',
                            balance: 25000,
                            clicks: 8000,
                            earned: 35000,
                            friends: [],
                            photoUrl: null
                        },
                        {
                            id: 333333,
                            firstName: 'Дмитрий',
                            lastName: 'Сидоров',
                            username: 'dmitry_sidorov',
                            balance: 18000,
                            clicks: 6000,
                            earned: 22000,
                            friends: [],
                            photoUrl: null
                        },
                        {
                            id: 444444,
                            firstName: 'Елена',
                            lastName: 'Кузнецова',
                            username: 'elena_kuznetsova',
                            balance: 32000,
                            clicks: 10000,
                            earned: 45000,
                            friends: [],
                            photoUrl: null
                        },
                        {
                            id: 555555,
                            firstName: 'Иван',
                            lastName: 'Смирнов',
                            username: 'ivan_smirnov',
                            balance: 12000,
                            clicks: 4000,
                            earned: 15000,
                            friends: [],
                            photoUrl: null
                        }
                    ];
                    
                    testUsers.forEach(user => this.users.set(user.id, user));
                    this.save();
                }
            }
            
            static getUser(id) {
                return this.users.get(id);
            }
            
            static addUser(user) {
                this.users.set(user.id, user);
                this.save();
            }
            
            static updateUser(id, updates) {
                const user = this.users.get(id);
                if (user) {
                    Object.assign(user, updates);
                    this.save();
                }
            }
            
            static getAllUsers() {
                return Array.from(this.users.values());
            }
            
            static getTopUsers(limit = 10, sortBy = 'balance') {
                const users = this.getAllUsers();
                return users
                    .sort((a, b) => b[sortBy] - a[sortBy])
                    .slice(0, limit);
            }
            
            static save() {
                localStorage.setItem('imbabank_global_users', JSON.stringify(this.getAllUsers()));
            }
        }

        // Инициализация глобальных пользователей
        GlobalUsers.init();

        // Основное приложение
        class ImbaBankApp {
            constructor() {
                this.userData = new UserData();
                this.upgradeManager = new UpgradeManager();
                this.clickerStats = {
                    perClick: 10,
                    multiplier: 1.0,
                    autoClicker: false,
                    friendMultiplier: 0
                };
                
                this.selectedFriend = null;
                this.currentLeaderboardTab = 'balance';
                
                this.isClicking = false;
                this.autoClickerInterval = null;
                
                this.init();
            }

            init() {
                this.loadUserStats();
                this.updateUI();
                this.setupEventListeners();
                this.startAutoClicker();
                
                // Обновляем данные пользователя в глобальной системе
                this.updateGlobalUser();
            }

            loadUserStats() {
                // Загружаем улучшения пользователя
                this.userData.upgrades.forEach(upgradeId => {
                    const upgrade = this.upgradeManager.upgrades.find(u => u.id === upgradeId);
                    if (upgrade && upgrade.effect) {
                        if (upgrade.effect.perClick) {
                            this.clickerStats.perClick += upgrade.effect.perClick;
                        }
                        if (upgrade.effect.multiplier) {
                            this.clickerStats.multiplier *= upgrade.effect.multiplier;
                        }
                        if (upgrade.effect.autoClicker) {
                            this.clickerStats.autoClicker = true;
                        }
                        if (upgrade.effect.friendMultiplier) {
                            this.clickerStats.friendMultiplier += upgrade.effect.friendMultiplier;
                        }
                    }
                });
                
                // Применяем бонус за друзей
                if (this.userData.friends.length > 0 && this.clickerStats.friendMultiplier > 0) {
                    this.clickerStats.multiplier += this.userData.friends.length * this.clickerStats.friendMultiplier;
                }
            }

            updateUI() {
                // Обновляем Telegram данные
                this.updateTelegramData();
                
                // Обновляем баланс
                document.getElementById('userBalance').textContent = 
                    `${this.userData.balance.toLocaleString('ru-RU')} ИК`;
                document.getElementById('totalBalance').textContent = 
                    this.userData.balance.toLocaleString('ru-RU');
                document.getElementById('profileBalance').textContent = 
                    this.userData.balance.toLocaleString('ru-RU');

                // Обновляем статистику кликера
                document.getElementById('perClick').textContent = 
                    Math.floor(this.clickerStats.perClick * this.clickerStats.multiplier);
                document.getElementById('multiplier').textContent = 
                    `x${this.clickerStats.multiplier.toFixed(1)}`;
                document.getElementById('clicksCount').textContent = 
                    this.userData.clicks.toLocaleString('ru-RU');
                document.getElementById('totalEarned').textContent = 
                    this.userData.earned.toLocaleString('ru-RU');

                // Обновляем профиль
                document.getElementById('profileClicks').textContent = 
                    this.userData.clicks.toLocaleString('ru-RU');
                document.getElementById('profileEarned').textContent = 
                    this.userData.earned.toLocaleString('ru-RU');
                document.getElementById('profileCards').textContent = 
                    this.userData.cards.length;
                document.getElementById('profileFriends').textContent = 
                    this.userData.friends.length;

                // Обновляем улучшения
                this.updateUpgradesList();

                // Обновляем карты
                this.updateCardsList();

                // Обновляем лидерборд
                this.updateLeaderboard();

                // Обновляем друзей
                this.updateFriendsList();

                // Обновляем запросы
                this.updateRequestsList();

                // Обновляем бейдж запросов
                this.updateRequestsBadge();
            }

            updateTelegramData() {
                const tgData = this.userData.telegramData;
                if (tgData) {
                    // Обновляем имя
                    const fullName = `${tgData.firstName} ${tgData.lastName || ''}`.trim();
                    document.getElementById('userName').textContent = fullName || tgData.username || 'Пользователь';
                    document.getElementById('userId').textContent = `ID: ${tgData.id}`;
                    
                    // Обновляем аватар
                    const avatarContainer = document.getElementById('userAvatar');
                    const placeholder = document.getElementById('avatarPlaceholder');
                    
                    if (tgData.photoUrl) {
                        avatarContainer.innerHTML = `<img src="${tgData.photoUrl}" alt="Аватар">`;
                    } else if (placeholder) {
                        const initials = tgData.firstName ? tgData.firstName[0] : 
                                       tgData.lastName ? tgData.lastName[0] : 
                                       tgData.username ? tgData.username[0] : 'Т';
                        placeholder.textContent = initials.toUpperCase();
                    }
                }
            }

            updateGlobalUser() {
                const tgData = this.userData.telegramData;
                if (tgData) {
                    const globalUser = GlobalUsers.getUser(tgData.id) || {};
                    GlobalUsers.updateUser(tgData.id, {
                        id: tgData.id,
                        firstName: tgData.firstName,
                        lastName: tgData.lastName,
                        username: tgData.username,
                        photoUrl: tgData.photoUrl,
                        balance: this.userData.balance,
                        clicks: this.userData.clicks,
                        earned: this.userData.earned,
                        friends: this.userData.friends.map(f => f.id)
                    });
                }
            }

            updateUpgradesList() {
                const container = document.getElementById('upgradesList');
                const availableUpgrades = this.upgradeManager.getAvailableUpgrades(this.userData);

                container.innerHTML = availableUpgrades.map(upgrade => {
                    const canAfford = this.userData.balance >= upgrade.price;
                    const isDisabled = !canAfford;
                    
                    return `
                        <div class="upgrade-card ${isDisabled ? 'disabled' : ''}" 
                             data-id="${upgrade.id}" 
                             data-price="${upgrade.price}"
                             ${isDisabled ? 'onclick="app.showToast(\'Недостаточно средств\')"' : ''}>
                            <div class="upgrade-info">
                                <div class="upgrade-name">
                                    <i class="fas ${upgrade.icon}"></i> ${upgrade.name}
                                </div>
                                <div class="upgrade-desc">${upgrade.description}</div>
                                <div class="upgrade-price">${upgrade.price.toLocaleString('ru-RU')} ИК</div>
                            </div>
                            ${this.userData.upgrades.includes(upgrade.id) ? 
                                '<div class="upgrade-owned"><i class="fas fa-check"></i> Куплено</div>' : 
                                canAfford ? '<i class="fas fa-shopping-cart"></i>' : ''
                            }
                        </div>
                    `;
                }).join('');

                // Добавляем обработчики для доступных улучшений
                container.querySelectorAll('.upgrade-card:not(.disabled)').forEach(card => {
                    card.addEventListener('click', () => this.buyUpgrade(card.dataset.id, parseInt(card.dataset.price)));
                });
            }

            updateCardsList() {
                const container = document.getElementById('cardsList');
                
                container.innerHTML = this.userData.cards.map(card => `
                    <div class="card-item">
                        <div class="card-number">${card.number}</div>
                        <div class="card-balance">${card.balance.toLocaleString('ru-RU')} ИК</div>
                        <div class="card-name">${card.name}</div>
                    </div>
                `).join('');
            }

            updateLeaderboard() {
                const container = document.getElementById('leaderboardList');
                const topUsers = GlobalUsers.getTopUsers(10, this.currentLeaderboardTab);
                const currentUserId = this.userData.telegramData?.id;
                
                // Находим позицию текущего пользователя
                const allUsers = GlobalUsers.getAllUsers();
                allUsers.sort((a, b) => b[this.currentLeaderboardTab] - a[this.currentLeaderboardTab]);
                const userRank = allUsers.findIndex(u => u.id === currentUserId) + 1;
                
                document.getElementById('playerRank').textContent = userRank ? `#${userRank}` : 'Не в топе';
                
                container.innerHTML = topUsers.map((user, index) => {
                    const rank = index + 1;
                    const isMe = user.id === currentUserId;
                    const name = `${user.firstName} ${user.lastName || ''}`.trim() || user.username;
                    const score = user[this.currentLeaderboardTab].toLocaleString('ru-RU');
                    
                    return `
                        <div class="leaderboard-item ${isMe ? 'me' : ''}">
                            <div class="rank rank-${rank}">${rank}</div>
                            <div class="leaderboard-avatar">
                                ${user.photoUrl ? 
                                    `<img src="${user.photoUrl}" alt="${name}">` :
                                    `<div class="avatar-placeholder">${name[0]?.toUpperCase() || '?'}</div>`
                                }
                            </div>
                            <div class="leaderboard-info">
                                <div class="leaderboard-name">${name}</div>
                                <div class="leaderboard-level">ID: ${user.id}</div>
                            </div>
                            <div class="leaderboard-score">${score} ${this.currentLeaderboardTab === 'balance' ? 'ИК' : ''}</div>
                        </div>
                    `;
                }).join('');
            }

            updateFriendsList() {
                const container = document.getElementById('friendsList');
                const searchInput = document.getElementById('friendsSearch');
                const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
                
                let friends = this.userData.friends;
                if (searchTerm) {
                    friends = friends.filter(friend => 
                        friend.name.toLowerCase().includes(searchTerm) ||
                        friend.username?.toLowerCase().includes(searchTerm) ||
                        friend.id.toString().includes(searchTerm)
                    );
                }
                
                container.innerHTML = friends.map(friend => `
                    <div class="friend-item" data-friend-id="${friend.id}">
                        <div class="friend-avatar">
                            ${friend.photoUrl ? 
                                `<img src="${friend.photoUrl}" alt="${friend.name}">` :
                                `<div class="avatar-placeholder">${friend.name[0]?.toUpperCase() || '?'}</div>`
                            }
                        </div>
                        <div class="friend-info">
                            <div class="friend-name">${friend.name}</div>
                            <div class="friend-balance">${friend.balance ? friend.balance.toLocaleString('ru-RU') + ' ИК' : 'Нет данных'}</div>
                        </div>
                        <div class="friend-actions">
                            <button class="friend-btn send" onclick="app.sendMoneyToFriend(${friend.id})">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                            <button class="friend-btn request" onclick="app.requestLoanFromFriend(${friend.id})">
                                <i class="fas fa-hand-holding-usd"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
                
                // Добавляем обработчики для выбора друга
                container.querySelectorAll('.friend-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        if (!e.target.closest('.friend-btn')) {
                            const friendId = parseInt(item.dataset.friendId);
                            this.showFriendDetails(friendId);
                        }
                    });
                });
            }

            updateRequestsList() {
                const container = document.getElementById('requestsList');
                const incomingRequests = this.userData.incomingRequests.filter(r => r.status === 'pending');
                
                if (incomingRequests.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-muted" style="padding: 20px;">
                            Нет активных запросов
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = incomingRequests.map(request => {
                    const fromUser = GlobalUsers.getUser(request.fromUserId);
                    const name = fromUser ? `${fromUser.firstName} ${fromUser.lastName || ''}`.trim() : `Пользователь ${request.fromUserId}`;
                    
                    return `
                        <div class="request-item">
                            <div class="request-header">
                                <div class="request-user">
                                    <div class="request-avatar">
                                        ${fromUser?.photoUrl ? 
                                            `<img src="${fromUser.photoUrl}" alt="${name}">` :
                                            `<div class="avatar-placeholder">${name[0]?.toUpperCase() || '?'}</div>`
                                        }
                                    </div>
                                    <div class="request-name">${name}</div>
                                </div>
                                <div class="request-amount">${request.amount.toLocaleString('ru-RU')} ИК</div>
                            </div>
                            <div class="request-message">${request.message || 'Без сообщения'}</div>
                            <div class="request-actions">
                                <button class="request-btn accept" onclick="app.respondToRequest(${request.id}, true)">
                                    <i class="fas fa-check"></i> Дать
                                </button>
                                <button class="request-btn reject" onclick="app.respondToRequest(${request.id}, false)">
                                    <i class="fas fa-times"></i> Отказать
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            updateRequestsBadge() {
                const badge = document.getElementById('requestsBadge');
                const incomingRequests = this.userData.incomingRequests.filter(r => r.status === 'pending');
                
                if (incomingRequests.length > 0) {
                    badge.textContent = incomingRequests.length > 99 ? '99+' : incomingRequests.length;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
            }

            setupEventListeners() {
                // Кликер
                const clickerBtn = document.getElementById('clickerBtn');
                clickerBtn.addEventListener('touchstart', this.handleClick.bind(this), { passive: true });
                clickerBtn.addEventListener('mousedown', this.handleClick.bind(this), { passive: true });
                clickerBtn.addEventListener('click', this.handleClick.bind(this));

                // Навигация
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        const page = tab.dataset.page;
                        this.showPage(page);
                        
                        // Обновляем активный таб
                        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                    });
                });

                // Табы лидерборда
                document.querySelectorAll('.leaderboard-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        const tabName = tab.dataset.tab;
                        this.currentLeaderboardTab = tabName;
                        
                        // Обновляем активный таб
                        document.querySelectorAll('.leaderboard-tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        
                        this.updateLeaderboard();
                    });
                });

                // Поиск друзей
                const searchInput = document.getElementById('friendsSearch');
                if (searchInput) {
                    searchInput.addEventListener('input', () => {
                        this.updateFriendsList();
                    });
                }

                // Обработчики событий Telegram
                TelegramWebApp.onEvent('viewportChanged', this.handleViewportChange.bind(this));
            }

            handleClick(e) {
                // Предотвращаем быстрое множественное нажатие
                if (this.isClicking) return;
                
                this.isClicking = true;
                
                // Анимация клика
                e.currentTarget.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    e.currentTarget.style.transform = 'scale(1)';
                }, 100);

                // Расчет заработка
                const baseEarning = this.clickerStats.perClick;
                const multiplier = this.clickerStats.multiplier;
                
                // Шанс x2 (25%)
                let earnings = Math.floor(baseEarning * multiplier);
                if (Math.random() < 0.25) {
                    earnings *= 2;
                    this.showToast('Удача! x2 заработок!', 'success');
                }

                // Обновляем данные
                this.userData.addClick();
                this.userData.addBalance(earnings);
                
                // Добавляем транзакцию
                this.userData.addTransaction({
                    id: Date.now(),
                    type: 'income',
                    amount: earnings,
                    description: 'Заработок в кликере',
                    date: new Date().toLocaleDateString(),
                    time: Date.now()
                });

                // Обновляем глобальные данные
                this.updateGlobalUser();

                // Обновляем интерфейс
                this.updateUI();

                // Разрешаем следующий клик через 50мс (20 кликов в секунду максимум)
                setTimeout(() => {
                    this.isClicking = false;
                }, 50);
            }

            buyUpgrade(upgradeId, price) {
                if (this.userData.spendBalance(price)) {
                    const upgrade = this.upgradeManager.upgrades.find(u => u.id === upgradeId);
                    
                    // Применяем улучшение
                    if (upgrade.effect.perClick) {
                        this.clickerStats.perClick += upgrade.effect.perClick;
                    }
                    if (upgrade.effect.multiplier) {
                        this.clickerStats.multiplier *= upgrade.effect.multiplier;
                    }
                    if (upgrade.effect.autoClicker) {
                        this.clickerStats.autoClicker = true;
                        this.startAutoClicker();
                    }
                    if (upgrade.effect.friendMultiplier) {
                        this.clickerStats.friendMultiplier += upgrade.effect.friendMultiplier;
                    }

                    // Сохраняем улучшение
                    this.userData.addUpgrade(upgradeId);
                    
                    // Добавляем транзакцию
                    this.userData.addTransaction({
                        id: Date.now(),
                        type: 'outcome',
                        amount: price,
                        description: `Покупка: ${upgrade.name}`,
                        date: new Date().toLocaleDateString(),
                        time: Date.now()
                    });

                    // Обновляем интерфейс
                    this.updateUI();
                    this.showToast(`${upgrade.name} куплено!`, 'success');
                } else {
                    this.showToast('Недостаточно средств', 'error');
                }
            }

            startAutoClicker() {
                if (this.clickerStats.autoClicker && !this.autoClickerInterval) {
                    this.autoClickerInterval = setInterval(() => {
                        const earnings = Math.floor(this.clickerStats.perClick * this.clickerStats.multiplier * 0.5);
                        if (earnings > 0) {
                            this.userData.addBalance(earnings);
                            this.updateUI();
                        }
                    }, 1000); // Каждую секунду
                }
            }

            showPage(pageName) {
                // Скрываем все страницы
                document.querySelectorAll('.page').forEach(page => {
                    page.classList.remove('active');
                });

                // Показываем нужную страницу
                const pageElement = document.getElementById(`${pageName}Page`);
                if (pageElement) {
                    pageElement.classList.add('active');
                    this.updateUI();
                }
            }

            // Друзья и переводы
            openAddFriendModal() {
                document.getElementById('addFriendModal').classList.add('active');
            }

            addFriend() {
                const friendId = parseInt(document.getElementById('friendIdInput').value);
                if (!friendId || friendId <= 0) {
                    this.showToast('Введите корректный ID', 'error');
                    return;
                }

                if (friendId === this.userData.telegramData?.id) {
                    this.showToast('Нельзя добавить себя в друзья', 'error');
                    return;
                }

                const friend = GlobalUsers.getUser(friendId);
                if (!friend) {
                    this.showToast('Пользователь не найден', 'error');
                    return;
                }

                const friendData = {
                    id: friend.id,
                    name: `${friend.firstName} ${friend.lastName || ''}`.trim() || friend.username,
                    username: friend.username,
                    photoUrl: friend.photoUrl,
                    balance: friend.balance
                };

                if (this.userData.addFriend(friendData)) {
                    this.closeModal('addFriendModal');
                    this.updateUI();
                    this.showToast('Друг успешно добавлен', 'success');
                    document.getElementById('friendIdInput').value = '';
                } else {
                    this.showToast('Этот пользователь уже в друзьях', 'error');
                }
            }

            showFriendDetails(friendId) {
                const friend = this.userData.friends.find(f => f.id === friendId);
                if (!friend) return;

                this.selectedFriend = friend;

                document.getElementById('friendDetailsName').textContent = friend.name;
                document.getElementById('friendDetailsBalance').textContent = 
                    friend.balance ? friend.balance.toLocaleString('ru-RU') : '0';
                
                const avatarContainer = document.getElementById('friendDetailsAvatar');
                if (friend.photoUrl) {
                    avatarContainer.innerHTML = `<img src="${friend.photoUrl}" alt="${friend.name}">`;
                } else {
                    avatarContainer.innerHTML = `<div class="avatar-placeholder">${friend.name[0]?.toUpperCase() || '?'}</div>`;
                }

                document.getElementById('friendDetailsModal').classList.add('active');
            }

            sendMoneyToFriend(friendId) {
                this.selectedFriend = this.userData.friends.find(f => f.id === friendId);
                this.openTransferModal();
            }

            requestLoanFromFriend(friendId) {
                this.selectedFriend = this.userData.friends.find(f => f.id === friendId);
                this.openLoanRequestModal();
            }

            sendMoneyToSelectedFriend() {
                this.openTransferModal();
            }

            requestLoanFromSelectedFriend() {
                this.openLoanRequestModal();
            }

            removeSelectedFriend() {
                if (this.selectedFriend) {
                    TelegramWebApp.showConfirm(
                        `Удалить ${this.selectedFriend.name} из друзей?`,
                        (confirmed) => {
                            if (confirmed) {
                                this.userData.removeFriend(this.selectedFriend.id);
                                this.closeModal('friendDetailsModal');
                                this.updateUI();
                                this.showToast('Друг удален', 'warning');
                                this.selectedFriend = null;
                            }
                        }
                    );
                }
            }

            openTransferModal() {
                const select = document.getElementById('transferFriendSelect');
                select.innerHTML = '';
                
                this.userData.friends.forEach(friend => {
                    const option = document.createElement('option');
                    option.value = friend.id;
                    option.textContent = `${friend.name} (${friend.balance ? friend.balance.toLocaleString('ru-RU') + ' ИК' : 'Нет данных'})`;
                    select.appendChild(option);
                });
                
                if (this.selectedFriend) {
                    select.value = this.selectedFriend.id;
                }
                
                document.getElementById('transferModal').classList.add('active');
            }

            sendTransfer() {
                const friendId = parseInt(document.getElementById('transferFriendSelect').value);
                const amount = parseInt(document.getElementById('transferAmount').value);
                const message = document.getElementById('transferMessage').value;
                
                if (!friendId || friendId <= 0) {
                    this.showToast('Выберите друга', 'error');
                    return;
                }
                
                if (!amount || amount <= 0) {
                    this.showToast('Введите корректную сумму', 'error');
                    return;
                }
                
                if (amount > this.userData.balance) {
                    this.showToast('Недостаточно средств', 'error');
                    return;
                }
                
                const friend = this.userData.friends.find(f => f.id === friendId);
                if (!friend) {
                    this.showToast('Друг не найден', 'error');
                    return;
                }
                
                // Выполняем перевод
                this.userData.spendBalance(amount);
                
                // Обновляем баланс друга в глобальной системе (симуляция)
                const globalFriend = GlobalUsers.getUser(friendId);
                if (globalFriend) {
                    globalFriend.balance += amount;
                    GlobalUsers.save();
                }
                
                // Добавляем транзакцию
                this.userData.addTransaction({
                    id: Date.now(),
                    type: 'outcome',
                    amount: amount,
                    description: `Перевод ${friend.name}: ${message || 'без сообщения'}`,
                    date: new Date().toLocaleDateString(),
                    time: Date.now()
                });
                
                this.closeModal('transferModal');
                this.updateUI();
                this.showToast(`Перевод ${amount} ИК выполнен`, 'success');
                
                // Очищаем форму
                document.getElementById('transferAmount').value = '';
                document.getElementById('transferMessage').value = '';
                this.selectedFriend = null;
            }

            openLoanRequestModal() {
                const select = document.getElementById('loanFriendSelect');
                select.innerHTML = '';
                
                this.userData.friends.forEach(friend => {
                    const option = document.createElement('option');
                    option.value = friend.id;
                    option.textContent = friend.name;
                    select.appendChild(option);
                });
                
                if (this.selectedFriend) {
                    select.value = this.selectedFriend.id;
                }
                
                document.getElementById('loanRequestModal').classList.add('active');
            }

            sendLoanRequest() {
                const friendId = parseInt(document.getElementById('loanFriendSelect').value);
                const amount = parseInt(document.getElementById('loanAmount').value);
                const message = document.getElementById('loanMessage').value;
                
                if (!friendId || friendId <= 0) {
                    this.showToast('Выберите друга', 'error');
                    return;
                }
                
                if (!amount || amount <= 0) {
                    this.showToast('Введите корректную сумму', 'error');
                    return;
                }
                
                const friend = this.userData.friends.find(f => f.id === friendId);
                if (!friend) {
                    this.showToast('Друг не найден', 'error');
                    return;
                }
                
                // Отправляем запрос
                const request = this.userData.sendLoanRequest(friendId, amount, message);
                
                // Симулируем получение запроса другом
                const globalFriend = GlobalUsers.getUser(friendId);
                if (globalFriend) {
                    // В реальном приложении здесь был бы push-уведомление
                    console.log(`Запрос в долг отправлен пользователю ${friendId}: ${amount} ИК`);
                }
                
                this.closeModal('loanRequestModal');
                this.updateUI();
                this.showToast('Запрос в долг отправлен', 'success');
                
                // Очищаем форму
                document.getElementById('loanAmount').value = '';
                document.getElementById('loanMessage').value = '';
                this.selectedFriend = null;
            }

            respondToRequest(requestId, accepted) {
                const request = this.userData.respondToLoanRequest(requestId, accepted);
                
                if (accepted && request) {
                    // Выдаем деньги
                    if (this.userData.spendBalance(request.amount)) {
                        // Обновляем баланс получателя в глобальной системе
                        const globalRequester = GlobalUsers.getUser(request.fromUserId);
                        if (globalRequester) {
                            globalRequester.balance += request.amount;
                            GlobalUsers.save();
                        }
                        
                        // Добавляем транзакцию
                        this.userData.addTransaction({
                            id: Date.now(),
                            type: 'outcome',
                            amount: request.amount,
                            description: `Заем пользователю ID: ${request.fromUserId}`,
                            date: new Date().toLocaleDateString(),
                            time: Date.now()
                        });
                        
                        this.showToast('Вы дали деньги в долг', 'success');
                    } else {
                        this.showToast('Недостаточно средств', 'error');
                    }
                } else if (!accepted) {
                    this.showToast('Вы отказали в займе', 'warning');
                }
                
                this.updateUI();
            }

            createCard() {
                const cardNumber = `0228 ${Math.floor(1000 + Math.random() * 9000)} ${Math.floor(1000 + Math.random() * 9000)} ${Math.floor(1000 + Math.random() * 9000)}`;
                const cardName = `Карта ${this.userData.cards.length + 1}`;
                
                const newCard = {
                    id: Date.now(),
                    number: cardNumber,
                    balance: 0,
                    name: cardName,
                    created: new Date().toISOString()
                };

                this.userData.addCard(newCard);
                this.updateUI();
                this.showToast('Новая карта создана', 'success');
            }

            resetProgress() {
                TelegramWebApp.showConfirm(
                    'Вы уверены? Весь прогресс будет сброшен.',
                    (confirmed) => {
                        if (confirmed) {
                            this.userData.reset();
                            this.clickerStats = {
                                perClick: 10,
                                multiplier: 1.0,
                                autoClicker: false,
                                friendMultiplier: 0
                            };
                            if (this.autoClickerInterval) {
                                clearInterval(this.autoClickerInterval);
                                this.autoClickerInterval = null;
                            }
                            this.updateUI();
                            this.showToast('Прогресс сброшен', 'warning');
                        }
                    }
                );
            }

            shareProfile() {
                const tgData = this.userData.telegramData;
                if (tgData) {
                    const shareText = `Мой профиль в ИмбаБанке:\nБаланс: ${this.userData.balance.toLocaleString('ru-RU')} ИК\nКликов: ${this.userData.clicks.toLocaleString('ru-RU')}\nДрузей: ${this.userData.friends.length}`;
                    
                    // В реальном приложении можно использовать Telegram API для шеринга
                    TelegramWebApp.showAlert(shareText);
                    this.showToast('Текст профиля скопирован', 'success');
                }
            }

            closeModal(modalId) {
                document.getElementById(modalId).classList.remove('active');
            }

            showToast(message, type = 'info') {
                // Создаем уведомление
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed;
                    top: 80px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: ${type === 'success' ? '#38A169' : type === 'error' ? '#E53E3E' : type === 'warning' ? '#D69E2E' : '#805AD5'};
                    color: white;
                    padding: 12px 24px;
                    border-radius: 12px;
                    z-index: 1000;
                    font-weight: 600;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    animation: toastSlideIn 0.3s ease;
                    max-width: 90%;
                    text-align: center;
                `;
                
                toast.textContent = message;
                document.body.appendChild(toast);
                
                // Удаляем через 3 секунды
                setTimeout(() => {
                    toast.style.animation = 'toastSlideOut 0.3s ease';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }

            handleViewportChange() {
                this.updateUI();
            }
        }

        // Создаем глобальный экземпляр приложения
        window.app = new ImbaBankApp();

        // Вспомогательные функции для глобального доступа
        window.showPage = (page) => app.showPage(page);
        window.createCard = () => app.createCard();

        // Инициализация при загрузке
        document.addEventListener('DOMContentLoaded', () => {
            // Предотвращаем масштабирование на iOS
            document.addEventListener('touchmove', (e) => {
                if (e.scale !== 1) {
                    e.preventDefault();
                }
            }, { passive: false });
        });

        // Обработчик для Telegram кнопки "Назад"
        TelegramWebApp.BackButton.onClick(() => {
            // Закрываем все модальные окна
            document.querySelectorAll('.modal.active').forEach(modal => {
                modal.classList.remove('active');
            });
            
            // Если нет открытых модалок, возвращаемся на главную
            if (document.querySelectorAll('.modal.active').length === 0) {
                app.showPage('clicker');
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                document.querySelector('.nav-tab[data-page="clicker"]').classList.add('active');
            }
        });
        
        TelegramWebApp.BackButton.show();

        // Добавляем стили для анимации тостов
        if (!document.querySelector('#toast-styles')) {
            const style = document.createElement('style');
            style.id = 'toast-styles';
            style.textContent = `
                @keyframes toastSlideIn {
                    from { transform: translateX(-50%) translateY(-20px); opacity: 0; }
                    to { transform: translateX(-50%) translateY(0); opacity: 1; }
                }
                @keyframes toastSlideOut {
                    from { transform: translateX(-50%) translateY(0); opacity: 1; }
                    to { transform: translateX(-50%) translateY(-20px); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        }
    </script>
</body>
</html>
